
#!/bin/bash

# ==============================================================================
# ðŸš€ ZAPFLOW MANAGER - AUTO INSTALLER (ZERO-TO-HERO)
# ==============================================================================
# InstalaÃ§Ã£o completa e automatizada para VPS Ubuntu 20.04+
# Configura SWAP, Docker, Evolution API e ZapFlow.
# ==============================================================================

set -e

GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}[1/9] Atualizando Sistema...${NC}"
sudo apt install -y curl git nano unzip ufw

echo -e "${BLUE}[2/9] Configurando SWAP (4GB)...${NC}"
if [ $(swapon --show | wc -l) -eq 0 ]; then
    sudo fallocate -l 4G /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
fi

echo -e "${BLUE}[3/9] Instalando Docker...${NC}"
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com | sh
    sudo usermod -aG docker $USER
fi

echo -e "${BLUE}[4/9] Instalando Node.js & PM2...${NC}"
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
    sudo apt install -y nodejs
    sudo npm install -g pm2 serve
fi

echo -e "${BLUE}[5/9] Configurando Evolution API...${NC}"
# Detectar IP do servidor automaticamente com fallbacks
SERVER_IP=$(hostname -I | awk '{print $1}' 2>/dev/null)
if [ -z "$SERVER_IP" ]; then
    SERVER_IP=$(ip addr show | grep "inet " | grep -v 127.0.0.1 | head -1 | awk '{print $2}' | cut -d'/' -f1 2>/dev/null)
fi
if [ -z "$SERVER_IP" ]; then
    SERVER_IP=$(ifconfig | grep "inet " | grep -v 127.0.0.1 | head -1 | awk '{print $2}' 2>/dev/null)
fi
if [ -z "$SERVER_IP" ]; then
    SERVER_IP="localhost"
    echo -e "${YELLOW}âš ï¸  NÃ£o foi possÃ­vel detectar o IP do servidor. Usando 'localhost'.${NC}"
else
    echo -e "${GREEN}âœ… IP do servidor detectado: ${SERVER_IP}${NC}"
fi

cat > docker-compose.yml <<EOL
services:
  evolution_api:
    image: evoapicloud/evolution-api:latest
    container_name: evolution_api
    restart: always
    shm_size: '2gb'
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - SERVER_URL=http://${SERVER_IP}:8080
      - AUTHENTICATION_API_KEY=B8349283-F143-429D-B6C2-9386E8016558
      - WEBSOCKET_ENABLED=true
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://user:password@evolution_postgres:5432/evolution
      - DATABASE_CLIENT_NAME=evolution_exchange
      - RABBITMQ_ENABLED=false
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://evolution_redis:6379/0
      - DEL_INSTANCE=false
      - STORE_MESSAGES=true
      - STORE_MESSAGE_UP=true
      - STORE_CONTACTS=true
      - STORE_CHATS=true
      - CONFIG_SESSION_PHONE_CLIENT=ZapFlow
      - CONFIG_SESSION_PHONE_NAME=Chrome
      - CONFIG_SESSION_PHONE_OS=Windows
      # - CONFIG_SESSION_PHONE_VERSION=2.3000.1029255529
      - CONFIG_SESSION_PHONE_SYNC_FULL_HISTORY=false
      - BROWSER_ARGS=["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--disable-gpu","--disable-software-rasterizer"]
      - CORS_ORIGIN=*
      - CORS_METHODS=POST,GET,PUT,DELETE,OPTIONS
      - CORS_CREDENTIALS=true
    depends_on:
      evolution_postgres:
        condition: service_healthy
      evolution_redis:
        condition: service_started

  evolution_postgres:
    image: postgres:15-alpine
    container_name: evolution_postgres
    restart: always
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=evolution
    volumes:
      - evolution_postgres_data:/var/lib/postgresql/data

  evolution_redis:
    image: redis:alpine
    container_name: evolution_redis
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - evolution_redis_data:/data

volumes:
  evolution_postgres_data:
  evolution_redis_data:
EOL

sudo docker compose up -d

echo -e "${BLUE}[6/8] Instalando PostgreSQL (para backend)...${NC}"
if ! command -v psql &> /dev/null; then
    sudo apt install -y postgresql postgresql-contrib
    sudo systemctl start postgresql
    sudo systemctl enable postgresql
fi

# Configurar PostgreSQL na porta alta (54321) para evitar conflitos
echo "Configurando PostgreSQL na porta 54321..."
PG_CONF=$(sudo find /etc/postgresql -name postgresql.conf 2>/dev/null | head -1)
if [ -n "$PG_CONF" ]; then
    # Fazer backup
    sudo cp "$PG_CONF" "${PG_CONF}.backup"
    # Alterar porta para 54321
    sudo sed -i "s/^#*port = .*/port = 54321/" "$PG_CONF" 2>/dev/null || sudo sed -i "s/^port = .*/port = 54321/" "$PG_CONF" 2>/dev/null
    # Se nÃ£o encontrou a linha, adicionar
    if ! grep -q "^port = 54321" "$PG_CONF"; then
        echo "port = 54321" | sudo tee -a "$PG_CONF" > /dev/null
    fi
    sudo systemctl restart postgresql
    echo -e "${GREEN}âœ… PostgreSQL configurado para usar porta 54321${NC}"
else
    echo -e "${YELLOW}âš ï¸  Arquivo de configuraÃ§Ã£o do PostgreSQL nÃ£o encontrado.${NC}"
    echo "Configure manualmente: sudo nano /etc/postgresql/*/main/postgresql.conf"
    echo "Altere 'port = 5432' para 'port = 54321'"
fi

# Aguardar PostgreSQL iniciar
sleep 2

# Configurar banco de dados (usando porta 54321)
sudo -u postgres PGPORT=54321 psql -c "CREATE DATABASE zapflow;" 2>/dev/null || echo "Banco zapflow jÃ¡ existe ou erro ao criar"
sudo -u postgres PGPORT=54321 psql -c "CREATE USER zapflow_user WITH PASSWORD 'zapflow_secure_password_2024';" 2>/dev/null || echo "UsuÃ¡rio jÃ¡ existe"
sudo -u postgres PGPORT=54321 psql -c "GRANT ALL PRIVILEGES ON DATABASE zapflow TO zapflow_user;" 2>/dev/null || true
sudo -u postgres PGPORT=54321 psql -c "ALTER USER zapflow_user CREATEDB;" 2>/dev/null || true

echo -e "${BLUE}[7/9] Configurando Backend API...${NC}"
cd backend 2>/dev/null || mkdir -p backend && cd backend

# Criar package.json se nÃ£o existir
if [ ! -f "package.json" ]; then
    cat > package.json <<EOL
{
  "name": "zapflow-backend",
  "version": "1.0.0",
  "description": "Backend API para ZapFlow com PostgreSQL",
  "type": "module",
  "main": "server.js",
  "scripts": {
    "dev": "node --watch server.js",
    "start": "node server.js",
    "migrate": "node scripts/migrate.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "pg": "^8.11.3",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "express-rate-limit": "^7.1.5"
  }
}
EOL
fi

# Instalar dependÃªncias do backend
npm install

# Gerar JWT secret
JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || head -c 32 /dev/urandom | base64 | tr -d '\n')

# Criar arquivo .env do backend
cat > .env <<EOL
# ConfiguraÃ§Ã£o do PostgreSQL (porta alta para evitar conflitos)
DATABASE_URL=postgresql://zapflow_user:zapflow_secure_password_2024@localhost:54321/zapflow
DB_HOST=localhost
DB_PORT=54321
DB_NAME=zapflow
DB_USER=zapflow_user
DB_PASSWORD=zapflow_secure_password_2024

# JWT Secret para autenticaÃ§Ã£o
JWT_SECRET=${JWT_SECRET}

# Porta do servidor
PORT=3001

# CORS - URLs permitidas
CORS_ORIGIN=http://${SERVER_IP}:5173,http://localhost:5173
EOL

# Verificar se os arquivos do backend existem
if [ ! -f "server.js" ] || [ ! -f "scripts/migrate.js" ]; then
    echo "âš ï¸  Arquivos do backend nÃ£o encontrados no diretÃ³rio backend/"
    echo "Certifique-se de que vocÃª fez git clone completo do repositÃ³rio."
    echo "Ou execute: git pull para atualizar o repositÃ³rio."
    echo ""
    echo "Continuando sem backend... (os dados serÃ£o salvos apenas no localStorage)"
    BACKEND_AVAILABLE=false
else
    BACKEND_AVAILABLE=true
    mkdir -p scripts
    
    # Executar migraÃ§Ã£o principal
    echo "Executando migraÃ§Ã£o principal do banco de dados..."
    npm run migrate || {
        echo "âš ï¸  Erro na migraÃ§Ã£o principal. Verificando conexÃ£o com PostgreSQL..."
        echo "Certifique-se de que o PostgreSQL estÃ¡ rodando e as credenciais estÃ£o corretas."
        BACKEND_AVAILABLE=false
    }
    
    # Executar migraÃ§Ãµes adicionais (se os scripts existirem)
    if [ "$BACKEND_AVAILABLE" = true ]; then
        echo "Executando migraÃ§Ãµes adicionais..."
        
        # Adicionar campo department_id na tabela users (se nÃ£o existir)
        if [ -f "scripts/add-department-id-to-users.js" ]; then
            echo "  - Adicionando campo department_id..."
            node scripts/add-department-id-to-users.js 2>/dev/null || echo "    Campo department_id jÃ¡ existe ou erro (pode ignorar)"
        fi
        
        # Corrigir data_keys de chats (opcional)
        if [ -f "scripts/fix-chat-data-keys.js" ]; then
            echo "  - Corrigindo data_keys de chats..."
            node scripts/fix-chat-data-keys.js 2>/dev/null || echo "    Nenhum chat para corrigir ou erro (pode ignorar)"
        fi
    fi
fi

cd ..

echo -e "${BLUE}[8/9] Configurando Frontend...${NC}"

# Garantir que estamos no diretÃ³rio raiz do projeto
# Se nÃ£o estiver, tentar encontrar o diretÃ³rio correto
if [ ! -f "package.json" ]; then
    # Tentar encontrar o diretÃ³rio do projeto
    if [ -d "ZapFlow" ] && [ -f "ZapFlow/package.json" ]; then
        cd ZapFlow
    elif [ -d "zapflow" ] && [ -f "zapflow/package.json" ]; then
        cd zapflow
    else
        echo "âš ï¸  package.json nÃ£o encontrado no diretÃ³rio atual."
        echo "   Certifique-se de estar no diretÃ³rio raiz do projeto ZapFlow."
        echo "   Ou execute: cd /caminho/para/ZapFlow antes de executar este script."
        exit 1
    fi
fi

# Verificar se package.json tem o script build
if ! grep -q '"build"' package.json; then
    echo "âš ï¸  Script 'build' nÃ£o encontrado no package.json."
    echo "   Adicionando script build ao package.json..."
    # Adicionar script build se nÃ£o existir
    if grep -q '"scripts"' package.json; then
        # Se jÃ¡ tem scripts, adicionar build
        sed -i '/"scripts"/a\    "build": "vite build",' package.json 2>/dev/null || {
            # Fallback para ediÃ§Ã£o manual
            echo "   Por favor, adicione manualmente: \"build\": \"vite build\" no package.json"
        }
    else
        # Se nÃ£o tem scripts, adicionar seÃ§Ã£o completa
        echo "   Por favor, adicione manualmente a seÃ§Ã£o scripts no package.json"
    fi
fi

# Configurar variÃ¡vel de ambiente do frontend para usar o backend
if [ "$BACKEND_AVAILABLE" = true ]; then
    if [ ! -f ".env" ]; then
        echo "VITE_API_URL=http://${SERVER_IP}:3001" > .env
        echo "âœ… Arquivo .env do frontend criado com URL do backend"
    else
        # Adicionar ou atualizar VITE_API_URL no .env existente
        if grep -q "VITE_API_URL" .env; then
            sed -i "s|VITE_API_URL=.*|VITE_API_URL=http://${SERVER_IP}:3001|" .env
        else
            echo "VITE_API_URL=http://${SERVER_IP}:3001" >> .env
        fi
        echo "âœ… VariÃ¡vel VITE_API_URL configurada no .env"
    fi
    echo "   ðŸ“ VITE_API_URL=http://${SERVER_IP}:3001"
fi

# Verificar se package.json existe antes de instalar
if [ ! -f "package.json" ]; then
    echo "âŒ Erro: package.json nÃ£o encontrado!"
    echo "   Certifique-se de estar no diretÃ³rio raiz do projeto ZapFlow."
    exit 1
fi

echo "ðŸ“¦ Instalando dependÃªncias do frontend..."
rm -rf node_modules package-lock.json
npm install

echo "ðŸ”¨ Construindo aplicaÃ§Ã£o frontend..."
if npm run build; then
    echo "âœ… Build do frontend concluÃ­do com sucesso!"
else
    echo "âš ï¸  Erro ao fazer build do frontend."
    echo "   Verifique os logs acima para mais detalhes."
    echo "   Continuando mesmo assim..."
fi

echo -e "${BLUE}[9/9] Finalizando...${NC}"

# Iniciar backend com PM2 (se os arquivos existirem e migraÃ§Ã£o foi bem-sucedida)
if [ "$BACKEND_AVAILABLE" = true ] && [ -f "backend/server.js" ]; then
    pm2 delete zapflow-backend 2>/dev/null || true
    cd backend
    pm2 start server.js --name zapflow-backend
    cd ..
    echo "âœ… Backend iniciado com PM2"
    
    # Aguardar servidor iniciar
    echo "Aguardando servidor backend iniciar..."
    sleep 5
    
    # Testar conectividade da API
    echo "Testando conectividade da API backend..."
    API_URL="http://${SERVER_IP}:3001/api/health"
    
    # Tentar conectar atÃ© 10 vezes (10 segundos)
    API_ACCESSIBLE=false
    for i in {1..10}; do
        if curl -s -f -m 2 "$API_URL" > /dev/null 2>&1; then
            API_ACCESSIBLE=true
            echo "âœ… API backend estÃ¡ acessÃ­vel em $API_URL"
            break
        fi
        echo -n "."
        sleep 1
    done
    echo ""
    
    if [ "$API_ACCESSIBLE" = false ]; then
        echo "âš ï¸  API backend nÃ£o estÃ¡ respondendo apÃ³s 10 segundos"
        echo "   Isso pode ser normal se o servidor ainda estÃ¡ inicializando"
        echo ""
        echo "Verifique:"
        echo "  1. Se o servidor estÃ¡ rodando: pm2 status"
        echo "  2. Logs do servidor: pm2 logs zapflow-backend"
        echo "  3. Se a porta estÃ¡ aberta no firewall (jÃ¡ configurado acima)"
        echo "  4. Teste manualmente: curl http://${SERVER_IP}:3001/api/health"
    fi
else
    echo "âš ï¸  Backend nÃ£o iniciado (arquivos nÃ£o encontrados ou erro na migraÃ§Ã£o)"
    echo "   Os dados serÃ£o salvos apenas no localStorage do navegador."
fi

# Iniciar frontend com PM2
pm2 delete zapflow-front 2>/dev/null || true
pm2 start "serve -s dist -l 5173" --name zapflow-front
pm2 save
pm2 startup | grep "sudo" | bash || true

# Configurar firewall
if command -v ufw &> /dev/null; then
    sudo ufw allow 8080  # Evolution API
    sudo ufw allow 5173  # Frontend
    sudo ufw allow 3001  # Backend API
    sudo ufw allow 22     # SSH
    sudo ufw allow 80    # HTTP
    sudo ufw --force enable
fi

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  INSTALAÃ‡ÃƒO CONCLUÃDA COM SUCESSO!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "ðŸŒ Frontend: http://${SERVER_IP}:5173"
echo -e "ðŸ”Œ Evolution API: http://${SERVER_IP}:8080"
echo -e "ðŸ’¾ Backend API: http://${SERVER_IP}:3001"
echo ""
echo -e "${BLUE}Credenciais padrÃ£o do admin:${NC}"
echo -e "   Username: ${GREEN}admin@piekas.com${NC}"
echo -e "   Password: ${GREEN}123${NC}"
echo -e "   ${BLUE}âš ï¸  ALTERE A SENHA EM PRODUÃ‡ÃƒO!${NC}"
echo ""
echo -e "${BLUE}PrÃ³ximos passos apÃ³s login:${NC}"
echo -e "   1. Criar departamentos em ${YELLOW}ConfiguraÃ§Ãµes > Departamentos${NC}"
echo -e "   2. Criar usuÃ¡rios e atribuir a departamentos em ${YELLOW}ConfiguraÃ§Ãµes > UsuÃ¡rios${NC}"
echo -e "   3. Configurar Gemini API Key em ${YELLOW}ConfiguraÃ§Ãµes > IntegraÃ§Ã£o Google${NC} (opcional)"
echo -e "   4. Configurar Chatbot em ${YELLOW}ConfiguraÃ§Ãµes > Chatbot${NC} (opcional)"
echo ""
echo -e "${BLUE}Comandos Ãºteis:${NC}"
echo -e "   ${YELLOW}pm2 status${NC}                    - Ver status de todos os serviÃ§os"
echo -e "   ${YELLOW}pm2 logs zapflow-backend${NC}     - Ver logs do backend"
echo -e "   ${YELLOW}pm2 logs zapflow-front${NC}       - Ver logs do frontend"
echo -e "   ${YELLOW}pm2 restart zapflow-backend${NC}  - Reiniciar backend"
echo -e "   ${YELLOW}pm2 restart zapflow-front${NC}    - Reiniciar frontend"
echo ""
echo -e "${BLUE}Testar APIs:${NC}"
echo -e "   ${YELLOW}curl http://${SERVER_IP}:3001/api/health${NC}     - Backend API Health Check"
echo -e "   ${YELLOW}curl -X POST http://${SERVER_IP}:3001/api/auth/login -H 'Content-Type: application/json' -d '{\"username\":\"admin@piekas.com\",\"password\":\"123\"}'${NC} - Teste de Login"
echo -e "   ${YELLOW}curl http://${SERVER_IP}:8080/instance/fetchInstances${NC} - Evolution API"
echo ""
echo -e "${BLUE}Se a API backend nÃ£o estiver acessÃ­vel:${NC}"
echo -e "   1. Verifique o firewall (jÃ¡ configurado acima)"
echo -e "   2. Verifique logs: ${YELLOW}pm2 logs zapflow-backend${NC}"
echo -e "   3. Reinicie o backend: ${YELLOW}pm2 restart zapflow-backend${NC}"
echo -e "   4. Verifique se estÃ¡ escutando no IP correto: ${YELLOW}netstat -tlnp | grep 3001${NC}"
echo ""
echo -e "${BLUE}DocumentaÃ§Ã£o completa:${NC}"
echo -e "   ðŸ“„ ${YELLOW}INSTALACAO_COMPLETA.md${NC} - Guia completo com todas as funcionalidades"
echo -e "   ðŸ“„ ${YELLOW}INSTALACAO_BACKEND.md${NC} - Guia especÃ­fico do backend"
echo -e "   ðŸ“„ ${YELLOW}backend/README.md${NC} - DocumentaÃ§Ã£o da API"
echo ""
echo -e "${BLUE}Funcionalidades implementadas:${NC}"
echo -e "   âœ… AtribuiÃ§Ã£o automÃ¡tica de chats ao operador do departamento"
echo -e "   âœ… Sistema de notificaÃ§Ãµes (operadores e administradores)"
echo -e "   âœ… PersistÃªncia completa no PostgreSQL"
echo -e "   âœ… ValidaÃ§Ã£o de nÃºmeros (11+ dÃ­gitos)"
echo -e "   âœ… Status persistente de chats"
echo -e "   âœ… Socket.IO para mensagens em tempo real"
echo -e "   âœ… Google Gemini AI para respostas inteligentes"
echo -e "   âœ… Chatbot com horÃ¡rios de funcionamento"
